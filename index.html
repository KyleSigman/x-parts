<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCVr3ZztynpNzkeFY3aLKFN777oPunon4o",
            authDomain: "inspector-24f9b.firebaseapp.com",
            databaseURL: "https://inspector-24f9b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inspector-24f9b",
            storageBucket: "inspector-24f9b.firebasestorage.app",
            messagingSenderId: "590955045913",
            appId: "1:590955045913:web:164311eb98caeca7643688"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        header {
            background-color: #1976d2;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .ui-button {
            background-color: #4fc3f7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .ui-button:hover {
            background-color: #03a9f4;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 70px);
        }

        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
        .clients-container {
            width: 30%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            overflow-y: auto;
        }

        .client-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .client-item:hover {
            background-color: #f0f7ff;
        }

        .client-item.active {
            background-color: #e3f2fd;
            font-weight: 600;
        }

        .car-list {
            margin-left: 20px;
            margin-top: 10px;
        }

        .car-item {
            padding: 10px;
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .car-item:hover {
            color: #1976d2;
            background-color: #f8f8f8;
        }

        .car-item.selected {
            background-color: #bbdefb;
            color: #1565c0;
            font-weight: 500;
        }

        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
        .content {
            width: 70%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .content-header {
            font-size: 1em;
            color: #1976d2;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #1976d2;
        }

        .parts-list {
            list-style-type: none;
        }

        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }

        .part-name {
            flex-grow: 1;
            font-weight: 500;
            color: #212121;
        }

        .part-article {
            font-family: 'Courier New', monospace;
            background-color: #e0f7fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            padding: 20px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #333;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab {
            padding: 10px 15px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #1976d2;
            color: white;
        }

        /* –§–æ—Ä–º—ã */
        .form {
            display: none;
        }

        .form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .submit-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #0d47a1;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .clients-container,
            .content {
                width: 100%;
            }
        }
    </style>
</head>

<body>
        <!-- –≠–∫—Ä–∞–Ω –¥–æ –≤—Ö–æ–¥–∞ -->
        <div id="authScreen" style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f5ff;">
            <button id="loginBtn" class="ui-button" style="padding:12px 24px; font-size:1.1em;">
                üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
            </button>
        </div>
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div id="mainApp" style="display:none;">
        <header>
            <div class="header-title">–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π</div>
            <button class="ui-button" id="uiButton">UI</button>
        </header>
        <!-- <header>
            <div class="header-title">–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π</div>
            <button class="ui-button" id="uiButton">‚öôÔ∏è</button>
        </header> -->
    
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div class="container">
            <div class="clients-container" id="clientsContainer"></div>
            <div class="content" id="content">
                <div class="content-header">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                <ul class="parts-list" id="partsList"></ul>
            </div>
        </div>
    
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div class="modal" id="modal">
            <div class="modal-content">
                <button class="close-btn" id="closeModal">&times;</button>
    
                <!-- –í–∫–ª–∞–¥–∫–∏ -->
                <div class="tabs">
                    <div class="tab active" data-tab="driver">–í–æ–¥–∏—Ç–µ–ª—å</div>
                    <div class="tab" data-tab="car">–ú–∞—à–∏–Ω–∞</div>
                    <div class="tab" data-tab="part">–ó–∞–ø—á–∞—Å—Ç—å</div>
                </div>
    
                <!-- –§–æ—Ä–º–∞ –≤–æ–¥–∏—Ç–µ–ª—è -->
                <form class="form active" id="driverForm">
                    <div class="form-group">
                        <label for="driverName">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</label>
                        <input type="text" id="driverName" required>
                    </div>
                    <div class="form-group">
                        <label for="driverContact">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                        <input type="text" id="driverContact" required>
                    </div>
                    <div class="form-group">
                        <label for="driverPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="driverPhone" required>
                    </div>
                    <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
                </form>
    
                <!-- –§–æ—Ä–º–∞ –º–∞—à–∏–Ω—ã -->
                <form class="form" id="carForm">
                    <div class="form-group">
                        <label for="carBrand">–ë—Ä–µ–Ω–¥</label>
                        <input type="text" id="carBrand" required>
                    </div>
                    <div class="form-group">
                        <label for="carVin">VIN</label>
                        <input type="text" id="carVin" required>
                    </div>
                    <div class="form-group">
                        <label for="carYear">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                        <input type="number" id="carYear" min="1990" max="2024" required>
                    </div>
                    <div class="form-group">
                        <label for="carPlate">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                        <input type="text" id="carPlate" required>
                    </div>
                    <div class="form-group">
                        <label for="carOwner">–í–ª–∞–¥–µ–ª–µ—Ü</label>
                        <select id="carOwner" required>
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É</button>
                </form>
    
                <!-- –§–æ—Ä–º–∞ –∑–∞–ø—á–∞—Å—Ç–∏ -->
                <form class="form" id="partForm">
                    <div class="form-group">
                        <label for="partArticle">–ê—Ä—Ç–∏–∫—É–ª</label>
                        <input type="text" id="partArticle" required>
                    </div>
                    <div class="form-group">
                        <label for="partName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="partName" required>
                    </div>
                    <div class="form-group">
                        <label for="partBrand">–ë—Ä–µ–Ω–¥</label>
                        <input type="text" id="partBrand" required>
                    </div>
                    <div class="form-group">
                        <label for="partCar">–î–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è</label>
                        <select id="partCar" required>
                            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </select>
                    </div>
                    <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>
                </form>
            </div>
        </div>
    
        <div style="text-align:center; margin-top:20px; display: none;">
            <button id="exportJsonBtn" class="ui-button">üì• –°–∫–∞—á–∞—Ç—å –≤—Å—é –±–∞–∑—É –∫–∞–∫ JSON</button>
            <pre id="jsonOutput"
                style="display:none; background:#f8f9fa; padding:15px; margin-top:10px; border-radius:6px; overflow:auto;"></pre>
        </div>
    </div>
    

    <script>
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const clientsContainer = document.getElementById('clientsContainer');
        const content = document.getElementById('content');
        const partsList = document.getElementById('partsList');
        const uiButton = document.getElementById('uiButton');
        const modal = document.getElementById('modal');
        const closeModal = document.getElementById('closeModal');
        const tabs = document.querySelectorAll('.tab');
        const forms = document.querySelectorAll('.form');
        const driverForm = document.getElementById('driverForm');
        const carForm = document.getElementById('carForm');
        const partForm = document.getElementById('partForm');
        const carOwnerSelect = document.getElementById('carOwner');
        const partCarSelect = document.getElementById('partCar');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        async function loadAndRender() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                const clientsSnapshot = await db.collection('clients').get();
                const clients = {};
                clientsSnapshot.forEach(doc => {
                    clients[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—à–∏–Ω—ã
                const vehiclesSnapshot = await db.collection('vehicles').get();
                const vehicles = {};
                vehiclesSnapshot.forEach(doc => {
                    vehicles[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø—á–∞—Å—Ç–∏
                const partsSnapshot = await db.collection('parts').get();
                const parts = {};
                partsSnapshot.forEach(doc => {
                    parts[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
                const compatSnapshot = await db.collection('compatibility').get();
                const compatibility = {};
                compatSnapshot.forEach(doc => {
                    compatibility[doc.id] = doc.data();
                });

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –º–∞—à–∏–Ω
                renderClientsAndCars(clients, vehicles);

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ö
                updateSelects(clients, vehicles);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
                alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase");
            }
        }

        function renderClientsAndCars(clients, vehicles) {
            clientsContainer.innerHTML = '';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –∑–∞–ø—á–∞—Å—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑
            db.collection('compatibility').get().then(compatSnapshot => {
                const compatibility = {};
                compatSnapshot.forEach(doc => {
                    compatibility[doc.id] = doc.data();
                });

                db.collection('parts').get().then(partsSnapshot => {
                    const parts = {};
                    partsSnapshot.forEach(doc => {
                        parts[doc.id] = doc.data();
                    });

                    for (const clientId in clients) {
                        const client = clients[clientId];

                        // –≠–ª–µ–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞
                        const clientItem = document.createElement('div');
                        clientItem.className = 'client-item';
                        clientItem.innerHTML = `
                    <div><strong>${client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong></div>
                    <div style="font-size: 0.85em; color: #666;">${client.phone || ''}</div>
                `;

                        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—à–∏–Ω (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                        const carList = document.createElement('div');
                        carList.className = 'car-list';
                        carList.style.display = 'none'; // ‚Üê —Å–∫—Ä—ã—Ç

                        // –°–æ–±–∏—Ä–∞–µ–º –º–∞—à–∏–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
                        const clientCars = [];
                        for (const vin in vehicles) {
                            const car = vehicles[vin];
                            if (car.owner_id === clientId) {
                                clientCars.push({ vin, car });
                            }
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—à–∏–Ω—ã –≤ —Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫
                        clientCars.forEach(({ vin, car }) => {
                            const carItem = document.createElement('div');
                            carItem.className = 'car-item';
                            carItem.innerHTML = `${car.brand || ''} (${car.year || '?'}) - ${car.plate || vin}`;
                            carItem.addEventListener('click', (e) => {
                                e.stopPropagation(); // –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É
                                document.querySelectorAll('.car-item').forEach(el => el.classList.remove('selected'));
                                carItem.classList.add('selected');
                                showPartsForCar(vin, car, compatibility, parts);
                            });
                            carList.appendChild(carItem);
                        });

                        // –ö–ª–∏–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞—à–∏–Ω
                        clientItem.addEventListener('click', () => {
                            const isVisible = carList.style.display === 'block';
                            carList.style.display = isVisible ? 'none' : 'block';
                        });

                        clientItem.appendChild(carList);
                        clientsContainer.appendChild(clientItem);
                    }
                });
            });
        }

        function showPartsForCar(vin, car, compatibility, parts) {
            const header = content.querySelector('.content-header');
            header.textContent = `–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è: ${car.brand || ''} ${car.model || ''} (${car.year || ''})`;

            partsList.innerHTML = '';

            const compat = compatibility[vin];
            if (compat && compat.parts && Array.isArray(compat.parts)) {
                compat.parts.forEach(article => {
                    const part = parts[article];
                    if (part) {
                        const partItem = document.createElement('li');
                        partItem.className = 'part-item';
                        partItem.innerHTML = `
                            <div class="part-name">${part.name || article}</div>
                            <div class="part-article">${part.article || article}</div>
                        `;
                        partsList.appendChild(partItem);
                    }
                });
            }

            if (partsList.children.length === 0) {
                partsList.innerHTML = '<li class="part-item">–ó–∞–ø—á–∞—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
            }
        }

        function updateSelects(clients, vehicles) {
            carOwnerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>';
            for (const id in clients) {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = clients[id].name || id;
                carOwnerSelect.appendChild(opt);
            }

            partCarSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
            for (const vin in vehicles) { // ‚Üê vin —ç—Ç–æ –∫–ª—é—á
                const car = vehicles[vin];
                const clientId = car.owner_id;
                const clientName = clients[clientId]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                const opt = document.createElement('option');
                opt.value = vin; // ‚úÖ –ø–µ—Ä–µ–¥–∞—ë–º VIN
                opt.textContent = `${car.brand || ''} (${car.year || ''}) ‚Äî ${clientName}`;
                partCarSelect.appendChild(opt);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        uiButton.addEventListener('click', () => modal.classList.add('show'));
        closeModal.addEventListener('click', () => modal.classList.remove('show'));

        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                const tabId = this.dataset.tab;
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                forms.forEach(f => f.classList.remove('active'));
                document.getElementById(`${tabId}Form`).classList.add('active');
            });
        });

        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏) ===
        driverForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const clientId = 'client_' + Date.now();
            const clientData = {
                id: clientId,
                name: document.getElementById('driverName').value,
                contact: document.getElementById('driverContact').value,
                phone: document.getElementById('driverPhone').value,
                cars: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('clients').doc(clientId).set(clientData)
                .then(() => {
                    alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!');
                    modal.classList.remove('show');
                    loadAndRender();
                })
                .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
        });

        carForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const vin = document.getElementById('carVin').value.trim().toUpperCase();
            if (vin.length !== 17) {
                alert('VIN –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 17 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ
            db.collection('vehicles').doc(vin).get().then(doc => {
                if (doc.exists) {
                    alert('‚ùå –ú–∞—à–∏–Ω–∞ —Å —Ç–∞–∫–∏–º VIN —É–∂–µ –µ—Å—Ç—å');
                    return;
                }

                const carData = {
                    vin: vin,
                    brand: document.getElementById('carBrand').value,
                    model: document.getElementById('carModel')?.value || '',
                    engine: document.getElementById('carEngine')?.value || '',
                    year: parseInt(document.getElementById('carYear').value),
                    plate: document.getElementById('carPlate').value,
                    owner_id: document.getElementById('carOwner').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('vehicles').doc(vin).set(carData).then(() => {
                    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –∫–ª–∏–µ–Ω—Ç—É
                    db.collection('clients').doc(carData.owner_id).update({
                        cars: firebase.firestore.FieldValue.arrayUnion(vin)
                    }).catch(() => { });
                    alert('‚úÖ –ú–∞—à–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    modal.classList.remove('show');
                    loadAndRender();
                });
            });
        });


        partForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const article = document.getElementById('partArticle').value.trim();
            if (!article) return;
            const partId = article;
            const partData = {
                article: article,
                name: document.getElementById('partName').value,
                brand: document.getElementById('partBrand').value,
                system: 'unknown',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('parts').doc(partId).set(partData)
                .then(() => {
                    const vin = document.getElementById('partCar').value;
                    const compatRef = db.collection('compatibility').doc(vin);
                    compatRef.get().then(doc => {
                        if (doc.exists) {
                            const partsList = doc.data().parts || [];
                            if (!partsList.includes(article)) {
                                compatRef.update({
                                    parts: firebase.firestore.FieldValue.arrayUnion(article)
                                });
                            }
                        } else {
                            compatRef.set({ parts: [article] });
                        }
                    });
                    alert('‚úÖ –ó–∞–ø—á–∞—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    modal.classList.remove('show');
                    loadAndRender();
                })
                .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
        });

        // –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        document.getElementById('exportJsonBtn').addEventListener('click', async () => {
            const exportData = { parts: {}, vehicles: {}, clients: {}, compatibility: {} };
            const collections = ['parts', 'vehicles', 'clients', 'compatibility'];
            for (const colName of collections) {
                const snapshot = await db.collection(colName).get();
                snapshot.forEach(doc => {
                    exportData[colName][doc.id] = doc.data();
                });
            }
            const jsonStr = JSON.stringify(exportData, null, 2);
            const output = document.getElementById('jsonOutput');
            output.textContent = jsonStr;
            output.style.display = 'block';
            output.focus();
            output.select();
            alert('–ì–æ—Ç–æ–≤–æ! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ parts_system.json');
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        // document.addEventListener('DOMContentLoaded', loadAndRender);

        // === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–±–µ–∑ —Å–ª–æ–º–∞ DOM) ===
        // document.addEventListener('DOMContentLoaded', () => {
        //     const loginBtn = document.getElementById('loginBtn');
        //     const authContainer = document.getElementById('authContainer');
        //     const uiButton = document.getElementById('uiButton');
        //     const userEmail = document.getElementById('userEmail');

        //     if (!loginBtn || !authContainer || !uiButton) return;

        //     const auth = firebase.auth();
        //     const provider = new firebase.auth.GoogleAuthProvider();

        //     loginBtn.onclick = () => {
        //         auth.signInWithPopup(provider).catch(alert);
        //     };

        //     // –°–∫—Ä—ã–≤–∞–µ–º UI-–∫–Ω–æ–ø–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ö–æ–¥
        //     uiButton.style.display = 'none';
        //     authContainer.style.display = 'flex';
        //     authContainer.style.alignItems = 'center';
        //     authContainer.style.gap = '10px';

        //     auth.onAuthStateChanged(user => {
        //         if (user) {
        //             // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª
        //             authContainer.style.display = 'none';
        //             uiButton.style.display = 'block';
        //             if (userEmail) userEmail.textContent = user.email || '';
        //             loadAndRender(); // ‚Üê –ì—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
        //         } else {
        //             // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        //             uiButton.style.display = 'none';
        //             authContainer.style.display = 'flex';
        //             // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        //             clientsContainer.innerHTML = '';
        //             partsList.innerHTML = '';
        //             content.querySelector('.content-header').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å';
        //         }
        //     });

        // });
        document.addEventListener('DOMContentLoaded', () => {
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    
    const authScreen = document.getElementById('authScreen');
    const mainApp = document.getElementById('mainApp');
    const loginBtn = document.getElementById('loginBtn');
    const uiButton = document.getElementById('uiButton');

    if (!authScreen || !mainApp || !loginBtn) return;

    loginBtn.onclick = () => {
        auth.signInWithPopup(provider).catch(err => {
            console.error(err);
            alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
        });
    };

    auth.onAuthStateChanged(user => {
        if (user) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            authScreen.style.display = 'none';
            mainApp.style.display = 'block';
            loadAndRender(); // –≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            authScreen.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });
});
    </script>

</body>

</html>
