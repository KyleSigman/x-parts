<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x-parts –≥–∞—Ä–∞–∂</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCVr3ZztynpNzkeFY3aLKFN777oPunon4o",
            authDomain: "inspector-24f9b.firebaseapp.com",
            databaseURL: "https://inspector-24f9b-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inspector-24f9b",
            storageBucket: "inspector-24f9b.firebasestorage.app",
            messagingSenderId: "590955045913",
            appId: "1:590955045913:web:164311eb98caeca7643688"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        header {
            background-color: #1976d2;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .ui-button {
            background-color: #4fc3f7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .ui-button:hover {
            background-color: #03a9f4;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 70px);
        }

        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
        .clients-container {
            width: 30%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            overflow-y: auto;
        }

        .client-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .client-item:hover {
            background-color: #f0f7ff;
        }

        .client-item.active {
            background-color: #e3f2fd;
            font-weight: 600;
        }

        .car-list {
            margin-left: 20px;
            margin-top: 10px;
        }

        .car-item {
            padding: 10px;
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .car-item:hover {
            color: #1976d2;
            background-color: #f8f8f8;
        }

        .car-item.selected {
            background-color: #bbdefb;
            color: #1565c0;
            font-weight: 500;
        }

        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
        .content {
            width: 70%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .content-header {
            font-size: 1em;
            color: #1976d2;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #1976d2;
        }

        .parts-list {
            list-style-type: none;
        }

        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }

        .part-name {
            flex-grow: 1;
            font-weight: 500;
            color: #212121;
        }

        .part-article {
            font-family: 'Courier New', monospace;
            background-color: #e0f7fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: start;
            z-index: 1000;
            overflow-y: auto;
            /* ‚Üê —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ */
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            margin-top: 50px;
            background-color: white;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            padding: 20px;
            position: relative;
            margin-bottom: 50px;

        }

        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            background-color: #f44336;
            /* –∫—Ä–∞—Å–Ω—ã–π */
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            line-height: 36px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transform: translate(50%, -50%);
            /* —Ü–µ–Ω—Ç—Ä –∫—Ä–µ—Å—Ç–∏–∫–∞ ‚Äî –≤ —É–≥–ª—É –æ–∫–Ω–∞ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .close-btn:hover {
            background-color: #d32f2f;
        }

        /* .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
            background: none;
            border: none;
        } */

        .close-btn:hover {
            color: #333;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .tab {
            padding: 10px 15px;
            background-color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background-color: #1976d2;
            color: white;
        }

        /* –§–æ—Ä–º—ã */
        .form {
            display: none;
        }

        .form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
        }

        .submit-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #0d47a1;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .clients-container,
            .content {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <header>
        <div class="header-title">x-parts –≥–∞—Ä–∞–∂</div>
        <button class="ui-button" id="uiButton">‚öôÔ∏è</button>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="clients-container" id="clientsContainer">
            <!-- –ö–ª–∏–µ–Ω—Ç—ã –∏ –∏—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="content" id="content">
            <div class="content-header">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
            <div id="filterControls" style="margin-bottom:15px; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fafafa; display:none;">
                <label style="margin-right:12px; display:inline-block;">
                    <input type="checkbox" id="filterByModel"> –ü–æ –º–æ–¥–µ–ª–∏
                </label>
                <label style="display:inline-block;">
                    <input type="checkbox" id="filterByEngine"> –ü–æ –¥–≤–∏–≥–∞—Ç–µ–ª—é
                </label>
            </div>
            <!-- <div id="filterControls" style="margin-bottom: 15px; display: none;">
                <label style="margin-right: 15px;">
                    <input type="checkbox" id="filterByModel"> –ü–æ –º–æ–¥–µ–ª–∏
                </label>
                <label>
                    <input type="checkbox" id="filterByEngine"> –ü–æ –¥–≤–∏–≥–∞—Ç–µ–ª—é
                </label>
            </div> -->
            <ul class="parts-list" id="partsList">
                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </ul>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" id="closeModal">
                <span>&times;</span>
            </button>
            <!-- <button class="close-btn" id="closeModal">&times;</button> -->

            <!-- –í–∫–ª–∞–¥–∫–∏ -->
            <select id="formSelector" class="form-selector"
                style="width:100%; padding:8px; margin-bottom:15px; font-size:1em; border:1px solid #ddd; border-radius:4px;">
                <option value="driver">üë• –í–æ–¥–∏—Ç–µ–ª—å</option>
                <option value="car">üöó –ú–∞—à–∏–Ω–∞</option>
                <option value="part">üîß –ó–∞–ø—á–∞—Å—Ç—å</option>
                <option value="compat">üî© –ì—Ä—É–ø–ø—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏</option> <!-- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê -->
            </select>

            <!-- –§–æ—Ä–º–∞ –≤–æ–¥–∏—Ç–µ–ª—è -->
            <form class="form active" id="driverForm">
                <div class="form-group">
                    <label for="driverName">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</label>
                    <input type="text" id="driverName" required>
                </div>
                <div class="form-group">
                    <label for="driverContact">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                    <input type="text" id="driverContact"> <!-- ‚Üê —É–±—Ä–∞–Ω–æ required -->
                </div>
                <div class="form-group">
                    <label for="driverPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="driverPhone"> <!-- ‚Üê —É–±—Ä–∞–Ω–æ required -->
                </div>
                <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
            </form>

            <!-- –§–æ—Ä–º–∞ –º–∞—à–∏–Ω—ã -->
            <!-- –§–æ—Ä–º–∞ –º–∞—à–∏–Ω—ã -->
            <form class="form" id="carForm">
                <div class="form-group">
                    <label for="carBrand">–ë—Ä–µ–Ω–¥</label>
                    <input type="text" id="carBrand">
                </div>
                <div class="form-group">
                    <label for="carVin">VIN</label>
                    <input type="text" id="carVin" required> <!-- ‚úÖ –æ—Å—Ç–∞—ë—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º -->
                    <div id="vinPreview"
                        style="margin-top:8px; padding:8px; background:#f0f8ff; border-radius:4px; font-size:0.9em; display:none;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="carModel">–ú–æ–¥–µ–ª—å</label>
                    <input type="text" id="carModel">
                </div>
                <div class="form-group">
                    <label for="carEngine">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                    <input type="text" id="carEngine">
                </div>
                <div class="form-group">
                    <label for="carYear">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                    <input type="number" id="carYear" min="1990" max="2030">
                </div>
                <div class="form-group">
                    <label for="carPlate">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                    <input type="text" id="carPlate">
                </div>
                <div class="form-group">
                    <label for="carOwner">–í–ª–∞–¥–µ–ª–µ—Ü</label>
                    <select id="carOwner" required>
                        <!-- –û–ø—Ü–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É</button>
            </form>
            <!-- <form class="form" id="carForm">
                <div class="form-group">
                    <label for="carBrand">–ë—Ä–µ–Ω–¥</label>
                    <input type="text" id="carBrand"> 
                </div>
                <div class="form-group">
                    <label for="carVin">VIN</label>
                    <input type="text" id="carVin" required> 
                    <div id="vinPreview" style="margin-top:8px; padding:8px; background:#f0f8ff; border-radius:4px; font-size:0.9em; display:none;"></div>
                </div>
                <div class="form-group">
                    <label for="carModel">–ú–æ–¥–µ–ª—å</label>
                    <input type="text" id="carModel"> 
                </div>
                <div class="form-group">
                    <label for="carEngine">–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                    <input type="text" id="carEngine"> 
                </div>
                <div class="form-group">
                    <label for="carYear">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</label>
                    <input type="number" id="carYear" min="1990" max="2024"> 
                </div>
                <div class="form-group">
                    <label for="carPlate">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                    <input type="text" id="carPlate"> 
                </div>
                <div class="form-group">
                    <label for="carOwner">–í–ª–∞–¥–µ–ª–µ—Ü</label>
                    <select id="carOwner" required> 

                    </select>
                </div>
                <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É</button>
            </form> -->

            <!-- –§–æ—Ä–º–∞ –∑–∞–ø—á–∞—Å—Ç–∏ -->
            <form class="form" id="partForm">
                <div class="form-group">
                    <label for="partArticle">–ê—Ä—Ç–∏–∫—É–ª</label>
                    <input type="text" id="partArticle" required> <!-- ‚úÖ –æ—Å—Ç–∞—ë—Ç—Å—è -->
                </div>
                <div class="form-group">
                    <label for="partName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="partName"> <!-- ‚Üê —É–±—Ä–∞–Ω–æ required -->
                </div>
                <div class="form-group">
                    <label for="partBrand">–ë—Ä–µ–Ω–¥</label>
                    <input type="text" id="partBrand"> <!-- ‚Üê —É–±—Ä–∞–Ω–æ required -->
                </div>
                <div class="form-group">
                    <label for="partCar">–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</label>
                    <select id="partCar"> <!-- ‚Üê —É–±—Ä–∞–Ω–æ required -->
                        <!-- –û–ø—Ü–∏–∏ -->
                    </select>
                </div>
                <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>
            </form>

            <!-- –§–æ—Ä–º–∞ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
            <form class="form" id="compatForm">
                <div class="form-group">
                    <label>ID –≥—Ä—É–ø–ø—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)</label>
                    <input type="text" id="compatId" placeholder="howo_t5g_mc07" required> <!-- ‚úÖ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π -->
                </div>
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)</label>
                    <input type="text" id="compatName" placeholder="HOWO T5G (MC07)" required> <!-- ‚úÖ -->
                </div>
                <div class="form-group">
                    <label>–ë—Ä–µ–Ω–¥</label>
                    <input type="text" id="compatBrand" placeholder="HOWO / SINOTRUK" required> <!-- ‚úÖ -->
                </div>
                <div class="form-group">
                    <label>–ú–æ–¥–µ–ª—å</label>
                    <input type="text" id="compatModel" placeholder="T5G"> <!-- –æ–∫ -->
                </div>
                <div class="form-group">
                    <label>–î–≤–∏–≥–∞—Ç–µ–ª—å</label>
                    <input type="text" id="compatEngine" placeholder="MC07"> <!-- –æ–∫ -->
                </div>
                <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
            </form>


        </div>
    </div>

    <div style="text-align:center; margin-top:20px; display: none;">
        <button id="exportJsonBtn" class="ui-button">üì• –°–∫–∞—á–∞—Ç—å –≤—Å—é –±–∞–∑—É –∫–∞–∫ JSON</button>
        <pre id="jsonOutput"
            style="display:none; background:#f8f9fa; padding:15px; margin-top:10px; border-radius:6px; overflow:auto;"></pre>
    </div>

    <script>
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const clientsContainer = document.getElementById('clientsContainer');
        const content = document.getElementById('content');
        const partsList = document.getElementById('partsList');
        const uiButton = document.getElementById('uiButton');
        const modal = document.getElementById('modal');
        const closeModal = document.getElementById('closeModal');
        const tabs = document.querySelectorAll('.tab');
        const forms = document.querySelectorAll('.form');
        const driverForm = document.getElementById('driverForm');
        const carForm = document.getElementById('carForm');
        const partForm = document.getElementById('partForm');
        const carOwnerSelect = document.getElementById('carOwner');
        const partCarSelect = document.getElementById('partCar');

        const WMI_MAP = {
            "LZZ": {
                "brand": "HOWO / SINOTRUK", "models": {
                    "5CL": "C7H", "5BP": "T7H", "5BR": "T5G", "1LC": "TH7", "1LD": "TX", "5CA": "A7",
                    "5DY": "T5G",  // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
                    "CL1D": "C7H", "CL2D": "C7H", "BL1D": "T7H", "BR1D": "T5G", "BR2D": "T5G"
                }
            },

            "LZW": {
                "brand": "HOWO", "models": {
                    "5AC": "T7H", "5AD": "T5G", "5AE": "C7H", "AC1A": "T7H", "AC2A": "T7H"
                }
            },
            "LVB": {
                "brand": "FOTON", "models": {
                    "4LA": "Auman", "4LB": "Aumark", "4LC": "Aumark S", "BJ4189": "Auman", "S6P": "Auman EST"
                }
            },
            "LFC": {
                "brand": "FAW", "models": {
                    "5EK": "J6", "5EL": "J7", "5EM": "J6P", "AC1A": "J6", "AC2A": "J6", "BC1A": "J7", "BC2A": "J7"
                }
            },
            "LSV": {
                "brand": "SHACMAN", "models": {
                    "5FA": "X3000", "5FB": "X6000", "5FC": "F3000", "AC1A": "X3000", "BC1A": "X3000"
                }
            },
            "LDP": {
                "brand": "DONGFENG", "models": {
                    "4KA": "Tianjin", "4KB": "KX", "4KC": "KL", "DFL": "Tianjin"
                }
            },
            "LJ1": {
                "brand": "JAC", "models": {
                    "5FA": "Heavy Truck", "5FB": "Light Truck", "HFC": "Heavy Truck"
                }
            },
            "LZG": {
                "brand": "SHAANXI", "models": {
                    "5HA": "X3000", "5HB": "M3000", "AC1A": "X3000", "WD615": "X3000"
                }
            },
            "LZX": {
                "brand": "BEIBEN", "models": {
                    "5NA": "V3", "5NB": "NG80", "ZZ3327": "V3"
                }
            },
            // –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è LGA
            "LGA": {
                "brand": "HOWO / SINOTRUK",
                "models": {
                    "G3D": "T7H",      // –ü—Ä–∏–º–µ—Ä: –∏–∑ VIN LGAG3DV21P8836707 ‚Üí G3D ‚Üí T7H
                    "V21": "C7H",     // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ (—É—Ç–æ—á–Ω–∏—Ç—å –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É)
                    "P88": "A7",    // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                    // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–¥—ã –º–æ–¥–µ–ª–µ–π –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                    "5CL": "C7H",
                    "5BP": "T7H",
                    "5BR": "T5G",
                    "5CA": "A7"
                }
            }
        };

        const YEAR_CODES = {
            'A': 2010, 'B': 2011, 'C': 2012, 'D': 2013, 'E': 2014,
            'F': 2015, 'G': 2016, 'H': 2017, 'J': 2018, 'K': 2019,
            'L': 2020, 'M': 2021, 'N': 2022, 'P': 2023, 'R': 2024,
            'S': 2025, 'T': 2026, 'V': 2027, 'W': 2028, 'X': 2029,
            'Y': 2030
        };

        function decodeVIN(vin) {
            vin = vin.trim().toUpperCase();
            const preview = { valid: false, brand: '', model: '', engine: '', year: null, serial: '' };

            const vinRegex = /^[A-HJ-NPR-Z0-9]{17}$/;
            if (!vinRegex.test(vin)) {
                return preview;
            }

            const wmi = vin.substring(0, 3);
            const vds = vin.substring(3, 8);
            const yearCode = vin.charAt(9);
            const serial = vin.substring(11);

            const brandInfo = WMI_MAP[wmi] || { brand: "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω", models: {} };
            preview.brand = brandInfo.brand;
            preview.year = YEAR_CODES[yearCode] || null;
            preview.serial = serial;
            preview.valid = true;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–¥–µ–ª—å
            preview.model = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
            for (const [code, modelName] of Object.entries(brandInfo.models)) {
                if (vds.startsWith(code)) {
                    preview.model = modelName;
                    break;
                }
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—å –ü–û –ú–û–î–ï–õ–ò

            const MODEL_TO_ENGINE = {
                "T5G": "MC07", "T7H": "MC11", "C7H": "MC11", "TH7": "MC11", "TX": "WP10", "A7": "WP10",
                "J6": "WP10", "J7": "WP12", "J6P": "WP13",
                "Auman": "WP12", "Auman EST": "WP12", "Aumark": "WP10",
                "X3000": "WP10", "X6000": "WP12", "F3000": "WD615",
                "Tianjin": "WD615", "KL": "WP10",
                "M3000": "WP10"
            };

            if (preview.model !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞") {
                preview.engine = MODEL_TO_ENGINE[preview.model] || "";
            }

            return preview;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ VIN
        document.getElementById('carVin').addEventListener('input', function () {
            // document.getElementById('carVin').addEventListener('blur', function () {
            const vin = this.value;
            const previewDiv = document.getElementById('vinPreview');

            if (!vin || vin.length !== 17) {
                previewDiv.style.display = 'none';
                return;
            }

            const decoded = decodeVIN(vin);
            if (!decoded.valid) {
                previewDiv.innerHTML = '<span style="color:red">‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π VIN</span>';
                previewDiv.style.display = 'block';
                return;
            }

            // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
            if (decoded.brand) document.getElementById('carBrand').value = decoded.brand;
            if (decoded.model !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞") {
                document.getElementById('carModel').value = decoded.model;
            }
            const engineInput = document.getElementById('carEngine');
            if (decoded.engine && engineInput && engineInput.value === '') {
                engineInput.value = decoded.engine;
            }
            // if (decoded.model !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞") document.getElementById('carModel').value = decoded.model;
            if (decoded.year) document.getElementById('carYear').value = decoded.year;

            // –ü—Ä–µ–≤—å—é
            let html = `üöó <b>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞:</b><br>`;
            html += `üè∑Ô∏è –ë—Ä–µ–Ω–¥: <b>${decoded.brand}</b><br>`;
            if (decoded.model !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞") html += `üìã –ú–æ–¥–µ–ª—å: <b>${decoded.model}</b><br>`;
            if (decoded.engine) html += `‚öôÔ∏è –î–≤–∏–≥–∞—Ç–µ–ª—å: <b>${decoded.engine}</b><br>`; // ‚Üê –≠–¢–ê –°–¢–†–û–ö–ê –î–û–ë–ê–í–õ–ï–ù–ê
            if (decoded.year) html += `üìÖ –ì–æ–¥: <b>${decoded.year}</b><br>`;
            html += `üî¢ –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: <code>${decoded.serial}</code>`;

            previewDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firebase –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        async function loadAndRender() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                const clientsSnapshot = await db.collection('clients').get();
                const clients = {};
                clientsSnapshot.forEach(doc => {
                    clients[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—à–∏–Ω—ã
                const vehiclesSnapshot = await db.collection('vehicles').get();
                const vehicles = {};
                vehiclesSnapshot.forEach(doc => {
                    vehicles[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø—á–∞—Å—Ç–∏
                const partsSnapshot = await db.collection('parts').get();
                const parts = {};
                partsSnapshot.forEach(doc => {
                    parts[doc.id] = doc.data();
                });

                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
                const compatSnapshot = await db.collection('compatibility').get();
                const compatibility = {};
                compatSnapshot.forEach(doc => {
                    compatibility[doc.id] = doc.data();
                });

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∏—Ö –º–∞—à–∏–Ω
                renderClientsAndCars(clients, vehicles);

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ö
                updateSelects(clients, vehicles);
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
                alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase");
            }
        }

        function renderClientsAndCars(clients, vehicles) {
            clientsContainer.innerHTML = '';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –∑–∞–ø—á–∞—Å—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑
            db.collection('compatibility').get().then(compatSnapshot => {
                const compatibility = {};
                compatSnapshot.forEach(doc => {
                    compatibility[doc.id] = doc.data();
                });

                db.collection('parts').get().then(partsSnapshot => {
                    const parts = {};
                    partsSnapshot.forEach(doc => {
                        parts[doc.id] = doc.data();
                    });

                    for (const clientId in clients) {
                        const client = clients[clientId];

                        // –≠–ª–µ–º–µ–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞
                        const clientItem = document.createElement('div');
                        clientItem.className = 'client-item';
                        clientItem.innerHTML = `
                    <div><strong>${client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong></div>
                    <div style="font-size: 0.85em; color: #666;">${client.phone || ''}</div>
                `;

                        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—à–∏–Ω (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                        const carList = document.createElement('div');
                        carList.className = 'car-list';
                        carList.style.display = 'none'; // ‚Üê —Å–∫—Ä—ã—Ç

                        // –°–æ–±–∏—Ä–∞–µ–º –º–∞—à–∏–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
                        const clientCars = [];
                        for (const vin in vehicles) {
                            const car = vehicles[vin];
                            if (car.owner_id === clientId) {
                                clientCars.push({ vin, car });
                            }
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—à–∏–Ω—ã –≤ —Å–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫
                        clientCars.forEach(({ vin, car }) => {
                            const carItem = document.createElement('div');
                            carItem.className = 'car-item';
                            carItem.setAttribute('data-vin', vin);
                            carItem.innerHTML = `${car.brand || ''} (${car.year || '?'}) - ${car.plate || vin}`;
                            // carItem.innerHTML = `${car.brand || ''} (${car.year || '?'}) - ${car.plate || vin}`;
                            carItem.addEventListener('click', (e) => {
                                e.stopPropagation(); // –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É
                                document.querySelectorAll('.car-item').forEach(el => el.classList.remove('selected'));
                                carItem.classList.add('selected');
                                showPartsForCar(vin, car);
                                // showPartsForCar(vin, car, parts);
                                // showPartsForCar(vin, car, compatibility, parts);
                            });
                            carList.appendChild(carItem);
                        });

                        // –ö–ª–∏–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞—à–∏–Ω
                        clientItem.addEventListener('click', () => {
                            const isVisible = carList.style.display === 'block';
                            carList.style.display = isVisible ? 'none' : 'block';
                        });

                        clientItem.appendChild(carList);
                        clientsContainer.appendChild(clientItem);
                    }
                });
            });
        }

        

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è ‚Äî –∫—ç—à —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
        let CACHED_FILTER_LINES = null;

        async function loadFiltersOnce() {
            if (CACHED_FILTER_LINES) return CACHED_FILTER_LINES;
            try {
                const response = await fetch('categories_export_full.txt');
                const text = await response.text();
                CACHED_FILTER_LINES = parseFiltersFromText(text);
                return CACHED_FILTER_LINES;
            } catch (e) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã:", e);
                return [];
            }
        }

        function parseFiltersFromText(text) {
            const lines = text.split('\n');
            let inFilters = false;
            const filterLines = [];
            for (const line of lines) {
                const clean = line.trim();
                if (clean === "=== FILTRY ===") {
                    inFilters = true;
                    continue;
                }
                if (inFilters && clean.startsWith("===")) {
                    break; // –≤—ã—Ö–æ–¥–∏–º –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ
                }
                if (inFilters && clean && !clean.startsWith("===")) {
                    filterLines.push(clean);
                }
            }
            return filterLines;
        }

        async function showPartsForCar(vin, car) {
    const header = content.querySelector('.content-header');
    header.textContent = `–§–∏–ª—å—Ç—Ä—ã –¥–ª—è: ${car.brand || ''} ${car.model || ''} (${car.year || ''})`;

    const filterControls = document.getElementById('filterControls');
    if (filterControls) filterControls.style.display = 'block';

    const filters = await loadFiltersOnce();

    const brandStr = (car.brand || '').trim().toLowerCase();
    const modelStr = (car.model || '').trim().toLowerCase();
    const engineStr = (car.engine || '').trim().toLowerCase();

    const brandTerms = brandStr.includes('/') 
        ? brandStr.split('/').map(s => s.trim()) 
        : [brandStr];

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±—Ä–µ–Ω–¥—É (–±–∞–∑–æ–≤–∞—è)
    let matched = filters.filter(line => {
        const lineLower = line.toLowerCase();
        return brandTerms.some(term => term && lineLower.includes(term));
    });

    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
    const filterByModel = document.getElementById('filterByModel')?.checked || false;
    const filterByEngine = document.getElementById('filterByEngine')?.checked || false;

    // –î–æ–ø. —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–æ–¥–µ–ª–∏/–¥–≤–∏–≥–∞—Ç–µ–ª—é
    if (filterByModel || filterByEngine) {
        matched = matched.filter(line => {
            const lineLower = line.toLowerCase();
            const hasModel = modelStr && lineLower.includes(modelStr);
            const hasEngine = engineStr && lineLower.includes(engineStr);

            if (filterByModel && filterByEngine) {
                return hasModel && hasEngine;
            } else if (filterByModel) {
                return hasModel;
            } else if (filterByEngine) {
                return hasEngine;
            }
            return true;
        });
    }

    partsList.innerHTML = '';

    if (matched.length === 0) {
        partsList.innerHTML = '<li class="part-item">–§–∏–ª—å—Ç—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</li>';
        return;
    }

    matched.forEach(line => {
        let highlighted = line;

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –º–æ–¥–µ–ª–∏
        if (modelStr && line.toLowerCase().includes(modelStr)) {
            const regex = new RegExp(`(${car.model.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark style="background:#4caf50;color:black;font-weight:bold;">$1</mark>');
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è
        if (engineStr && line.toLowerCase().includes(engineStr)) {
            const regex = new RegExp(`(${car.engine.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark style="background:#ff9800;color:white;font-weight:bold;">$1</mark>');
        }

        const el = document.createElement('li');
        el.className = 'part-item';

        // –ó–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –º–æ–¥–µ–ª–∏ –∏–ª–∏ –¥–≤–∏–≥–∞—Ç–µ–ª—é
        if ((modelStr && line.toLowerCase().includes(modelStr)) || 
            (engineStr && line.toLowerCase().includes(engineStr))) {
            el.style.border = '2px solid #4caf50';
            el.style.borderRadius = '6px';
        }

        el.innerHTML = `<div class="part-name">${highlighted}</div>`;
        partsList.appendChild(el);
    });
}

        


        function updateSelects(clients, vehicles) {
            // –í–ª–∞–¥–µ–ª—å—Ü—ã ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
            carOwnerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>';
            for (const id in clients) {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = clients[id].name || id;
                carOwnerSelect.appendChild(opt);
            }

            // –ó–∞–ø—á–∞—Å—Ç–∏ ‚Äî —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –ì–†–£–ü–ü–ê–ú, –∞ –Ω–µ –∫ –º–∞—à–∏–Ω–∞–º
            // –ü–æ—ç—Ç–æ–º—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é compatibility –∫–∞–∫ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
            db.collection('compatibility').get().then(snapshot => {
                partCarSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</option>';
                snapshot.forEach(doc => {
                    const group = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id; // ID –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: howo_t5g_mc07)
                    opt.textContent = group.name || doc.id; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
                    partCarSelect.appendChild(opt);
                });
            }).catch(err => {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä—É–ø–ø—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:", err);
                partCarSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            });
        }

        //         function updateSelects(clients, vehicles) {
        //     carOwnerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>';
        //     for (const id in clients) {
        //         const opt = document.createElement('option');
        //         opt.value = id;
        //         opt.textContent = clients[id].name || id;
        //         carOwnerSelect.appendChild(opt);
        //     }

        //     partCarSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
        //     for (const vin in vehicles) { // ‚Üê vin —ç—Ç–æ –∫–ª—é—á
        //         const car = vehicles[vin];
        //         const clientId = car.owner_id;
        //         const clientName = clients[clientId]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        //         const opt = document.createElement('option');
        //         opt.value = vin; // ‚úÖ –ø–µ—Ä–µ–¥–∞—ë–º VIN
        //         opt.textContent = `${car.brand || ''} (${car.year || ''}) ‚Äî ${clientName}`;
        //         partCarSelect.appendChild(opt);
        //     }
        // }


        // function updateSelects(clients, vehicles) {
        //     carOwnerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>';
        //     for (const id in clients) {
        //         const opt = document.createElement('option');
        //         opt.value = id;
        //         opt.textContent = clients[id].name || id;
        //         carOwnerSelect.appendChild(opt);
        //     }

        //     partCarSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
        //     for (const vehicleId in vehicles) {
        //         const car = vehicles[vehicleId];
        //         const clientId = car.owner_id;
        //         const clientName = clients[clientId]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        //         const opt = document.createElement('option');
        //         opt.value = vehicleId; // ‚Üê ID –¥–æ–∫—É–º–µ–Ω—Ç–∞, –Ω–µ VIN
        //         opt.textContent = `${car.brand || ''} (${car.year || ''}) ‚Äî ${clientName} [VIN: ${car.vin}]`;
        //         partCarSelect.appendChild(opt);
        //     }
        // }


        // function updateSelects(clients, vehicles) {
        //     // –í–ª–∞–¥–µ–ª—å—Ü—ã –¥–ª—è —Ñ–æ—Ä–º—ã –º–∞—à–∏–Ω—ã
        //     carOwnerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞</option>';
        //     for (const id in clients) {
        //         const opt = document.createElement('option');
        //         opt.value = id;
        //         opt.textContent = clients[id].name || id;
        //         carOwnerSelect.appendChild(opt);
        //     }

        //     // –ú–∞—à–∏–Ω—ã –¥–ª—è —Ñ–æ—Ä–º—ã –∑–∞–ø—á–∞—Å—Ç–∏
        //     partCarSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>';
        //     for (const vin in vehicles) {
        //         const car = vehicles[vin];
        //         const clientId = car.owner_id;
        //         const clientName = clients[clientId]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
        //         const opt = document.createElement('option');
        //         opt.value = vehicleId; // ‚Üê –Ω–æ –Ω—É–∂–Ω–æ –≤–∑—è—Ç—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        //         // opt.value = vin;
        //         opt.textContent = `${car.brand || ''} (${car.year || ''}) ‚Äî ${clientName}`;
        //         partCarSelect.appendChild(opt);
        //     }
        // }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        uiButton.addEventListener('click', () => modal.classList.add('show'));

        closeModal.addEventListener('click', () => modal.classList.remove('show'));

        document.getElementById('formSelector').addEventListener('change', function () {
            const formId = this.value;
            document.querySelectorAll('.form').forEach(f => f.classList.remove('active'));
            document.getElementById(formId + 'Form').classList.add('active');
        });



        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏) ===

        driverForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const clientId = 'client_' + Date.now();
            const clientData = {
                id: clientId,
                name: document.getElementById('driverName').value,
                contact: document.getElementById('driverContact').value,
                phone: document.getElementById('driverPhone').value,
                cars: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('clients').doc(clientId).set(clientData)
                .then(() => {
                    alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω!');
                    this.reset(); // ‚Üê –û–ß–ò–°–¢–ö–ê –§–û–†–ú–´
                    modal.classList.remove('show');
                    loadAndRender();
                })
                .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
        });

        carForm.addEventListener('submit', function (e) {
            e.preventDefault();

            let vin = document.getElementById('carVin').value.trim().toUpperCase();
            if (!vin) {
                alert('VIN –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID, –µ—Å–ª–∏ VIN –∫–æ—Ä–æ—á–µ 5 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–≤–µ–¥–µ–Ω–æ "12345")
            const useAsId = vin.length >= 5 ? vin : 'manual_' + Date.now();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ ID (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ 17-—Å–∏–º–≤–æ–ª—å–Ω–æ–º—É VIN)
            db.collection('vehicles').doc(useAsId).get().then(doc => {
                if (doc.exists) {
                    alert('‚ùå –ú–∞—à–∏–Ω–∞ —Å —Ç–∞–∫–∏–º VIN (–∏–ª–∏ ID) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                    return;
                }

                const carData = {
                    vin: vin, // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–≤–æ–¥
                    brand: document.getElementById('carBrand').value.trim(),
                    model: document.getElementById('carModel').value.trim(),
                    engine: document.getElementById('carEngine').value.trim(),
                    year: parseInt(document.getElementById('carYear').value) || null,
                    plate: document.getElementById('carPlate').value.trim(),
                    owner_id: document.getElementById('carOwner').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('vehicles').doc(useAsId).set(carData).then(() => {
                    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É
                    if (carData.owner_id) {
                        db.collection('clients').doc(carData.owner_id).update({
                            cars: firebase.firestore.FieldValue.arrayUnion(useAsId)
                        }).catch(() => { });
                    }
                    alert('‚úÖ –ú–∞—à–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    this.reset();
                    modal.classList.remove('show');
                    loadAndRender();
                }).catch(err => {
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
                });
            });
        });

        

        partForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const article = document.getElementById('partArticle').value.trim();
            if (!article) return;

            const partData = {
                article: article,
                name: document.getElementById('partName').value,
                brand: document.getElementById('partBrand').value,
                compat_group: document.getElementById('partCar').value, // ‚Üê ID –≥—Ä—É–ø–ø—ã
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('parts').doc(article).set(partData)
                .then(() => {
                    alert('‚úÖ –ó–∞–ø—á–∞—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    this.reset(); // ‚Üê –û–ß–ò–°–¢–ö–ê –§–û–†–ú–´
                    modal.classList.remove('show');
                    loadAndRender();
                })
                .catch(err => alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
        });


        document.getElementById('compatForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const id = document.getElementById('compatId').value.trim();
            const name = document.getElementById('compatName').value.trim();
            const brand = document.getElementById('compatBrand').value.trim();

            if (!id || !name || !brand) {
                alert('‚ùå ID, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –±—Ä–µ–Ω–¥ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
                return;
            }

            const groupData = {
                name: name,
                brand: brand,
                model: document.getElementById('compatModel').value.trim(),
                engine: document.getElementById('compatEngine').value.trim()
            };

            db.collection('compatibility').doc(id).set(groupData)
                .then(() => {
                    alert('‚úÖ –ì—Ä—É–ø–ø–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('compatForm').reset();
                    loadAndRender();
                })
                .catch(err => {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
                });
        });

        document.getElementById('exportJsonBtn').addEventListener('click', async () => {
            const exportData = { parts: {}, vehicles: {}, clients: {}, compatibility: {} };
            const collections = ['parts', 'vehicles', 'clients', 'compatibility'];
            for (const colName of collections) {
                const snapshot = await db.collection(colName).get();
                snapshot.forEach(doc => {
                    exportData[colName][doc.id] = doc.data();
                });
            }
            const jsonStr = JSON.stringify(exportData, null, 2);
            const output = document.getElementById('jsonOutput');
            output.textContent = jsonStr;
            output.style.display = 'block';
            output.focus();
            output.select();
            alert('–ì–æ—Ç–æ–≤–æ! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –≤—ã—à–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ parts_system.json');
        });

        document.addEventListener('change', function (e) {
    if (e.target.id === 'filterByModel' || e.target.id === 'filterByEngine') {
        // –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–∞—à–∏–Ω—É –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
        const selectedCarItem = document.querySelector('.car-item.selected');
        if (selectedCarItem) {
            const vin = selectedCarItem.getAttribute('data-vin');
            if (vin) {
                const vehicles = {}; // –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω—ã
                db.collection('vehicles').doc(vin).get().then(doc => {
                    if (doc.exists) {
                        showPartsForCar(vin, doc.data());
                    }
                });
            }
        }
    }
});
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', loadAndRender);
    </script>

</body>

</html>
